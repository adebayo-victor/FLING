<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .toggle-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            background-color: #f0f4f8;
            color: #1f2937;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.1s;
        }
        .dark .toggle-btn {
            background-color: #1f2937;
            color: #f0f4f8;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        .toggle-btn:hover {
            transform: scale(1.05);
        }

        .container {
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        #reader {
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            margin-top: 1.5rem;
            aspect-ratio: 16 / 9;
        }
        .dark #reader {
            border-color: #374151;
        }

        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            word-wrap: break-word;
            font-size: 1.125rem;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        /* Styling for the new validation status box */
        #validation-status {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.5s ease-in-out;
            border: 2px solid;
            min-height: 4rem; /* Ensure space for the message */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-valid {
            background-color: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }
        .dark .status-valid {
            background-color: #1f2937;
            color: #22c55e;
            border-color: #166534;
        }
        .status-used, .status-invalid {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #fca5a5;
        }
        .dark .status-used, .dark .status-invalid {
            background-color: #1f2937;
            color: #ef4444;
            border-color: #991b1b;
        }
        .status-loading {
            background-color: #eff6ff;
            color: #1e40af;
            border-color: #93c5fd;
        }
        .dark .status-loading {
            background-color: #1f2937;
            color: #60a5fa;
            border-color: #1e40af;
        }
        .camera-btn.active {
            @apply bg-green-500 text-white;
        }
        .dark .camera-btn.active {
            @apply bg-green-700 text-white;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center p-4">
    <button id="theme-toggle-btn" class="toggle-btn" aria-label="Toggle dark mode">
        <svg id="sun-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4.332 1.668a.5.5 0 00-.916.365l.555 1.11a.5.5 0 00.916-.365l-.555-1.11zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM4.332 15.668a.5.5 0 00.916.365l-.555-1.11a.5.5 0 00-.916.365l.555 1.11zM10 17a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-4.332-1.668a.5.5 0 00-.916-.365l-.555 1.11a.5.5 0 00.916.365l.555-1.11zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm4.332-6.332a.5.5 0 00-.916.365l-.555-1.11a.5.5 0 00.916-.365l.555 1.11z"></path>
        </svg>
        <svg id="moon-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
    </button>
    <div class="container bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-10 w-full max-w-3xl text-center">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">QR Code Scanner</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Scanning a QR code from your webcam...</p>
        
        <!-- Camera selection buttons -->
        <div id="camera-controls" class="flex justify-center gap-4 mt-4 hidden">
            <button id="front-camera-btn" class="camera-btn px-4 py-2 rounded-lg font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 transition-colors">
                Front Camera
            </button>
            <button id="rear-camera-btn" class="camera-btn px-4 py-2 rounded-lg font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 transition-colors">
                Rear Camera
            </button>
        </div>

        <div id="reader"></div>
        
        <!-- Updated to be a dedicated status display -->
        <div id="validation-status" class="hidden"></div>
    </div>
    <input type="hidden" value="{{event.id}}" class="event-id">
    <input type="hidden" value="{{event.url_key}}" class="event-key">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const htmlTag = document.documentElement;
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const resultDiv = document.getElementById('validation-status');
            const cameraControls = document.getElementById('camera-controls');
            const frontCameraBtn = document.getElementById('front-camera-btn');
            const rearCameraBtn = document.getElementById('rear-camera-btn');

            let html5QrCode = null;
            let currentCameraId = null;
            let frontCameraId = null;
            let rearCameraId = null;

            // Load theme from localStorage or use system preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlTag.classList.remove('light', 'dark');
                htmlTag.classList.add(savedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                htmlTag.classList.add('dark');
            } else {
                htmlTag.classList.add('light');
            }
            
            // Update the UI based on the current theme
            function updateThemeUI() {
                const isDarkMode = htmlTag.classList.contains('dark');
                const sunIcon = document.getElementById('sun-icon');
                const moonIcon = document.getElementById('moon-icon');
                if (isDarkMode) {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            // Toggle theme and save to localStorage
            themeToggleBtn.addEventListener('click', () => {
                if (htmlTag.classList.contains('dark')) {
                    htmlTag.classList.remove('dark');
                    htmlTag.classList.add('light');
                    localStorage.setItem('theme', 'light');
                } else {
                    htmlTag.classList.remove('light');
                    htmlTag.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
                updateThemeUI();
            });

            // Initial UI update
            updateThemeUI();

            // Function to display messages with a specified class
            function showMessage(message, className) {
                resultDiv.textContent = message;
                resultDiv.className = ''; // Clear all classes
                resultDiv.classList.add('w-full', 'rounded-xl', 'p-4', 'mt-4'); // Re-add base classes
                if (className) {
                    resultDiv.classList.add(className);
                }
                resultDiv.classList.remove('hidden');
            }

            // Function for making request and validation message
            async function validateCode(code, key) {
                showMessage('Validating ticket...', 'status-loading');
                try {
                    const response = await fetch('https://fling-2a4m.onrender.com/validation/' + document.querySelector(".event-id").value, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code, key: key })
                    });
                    const result = await response.json();

                    if (result.response === 'valid') {
                        showMessage(`Ticket Status: Valid`, 'status-valid');
                    } else if (result.response === 'used') {
                        showMessage(`Ticket Status: Used`, 'status-used');
                    } else if (result.response === 'invalid') {
                        showMessage(`Ticket Status: Invalid`, 'status-invalid');
                    } else {
                        showMessage('Unexpected response from server.', 'status-invalid');
                    }
                } catch (error) {
                    showMessage('Error validating ticket: ' + error.message, 'status-invalid');
                    console.error('Validation error:', error);
                }
            }
            
            // Function to start the scanner
            const startScanner = (cameraIdToUse) => {
                // Update button states
                if (frontCameraId) frontCameraBtn.classList.remove('active');
                if (rearCameraId) rearCameraBtn.classList.remove('active');
                if (cameraIdToUse === frontCameraId) {
                    frontCameraBtn.classList.add('active');
                } else if (cameraIdToUse === rearCameraId) {
                    rearCameraBtn.classList.add('active');
                }

                html5QrCode.start(
                    { deviceId: { exact: cameraIdToUse } }, 
                    { 
                        fps: 10,
                        qrbox: { width: 900, height: 900 }
                    },
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    console.error("Error starting scanner:", err);
                    showMessage(`Error: ${err.name}. Please ensure you have granted camera permissions.`, 'status-invalid');
                });
            };

            // This function is called every time a QR code is successfully scanned.
            const onScanSuccess = (decodedText, decodedResult) => {
                console.log(`Code matched = ${decodedText}`, decodedResult);
                
                // Stop the scanner immediately to prevent re-scanning
                html5QrCode.stop().then(() => {
                    const key = document.querySelector(".event-key").value;
                    validateCode(decodedText, key);

                    // Recommence scanning after a 5-second delay
                    setTimeout(() => {
                        showMessage('Scanning for a new code...', 'status-loading');
                        startScanner(currentCameraId);
                    }, 5000); // 5000 milliseconds = 5 seconds
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                    showMessage(`Error stopping scanner: ${err.name}`, 'status-invalid');
                });
            };

            // This function is called on scanning failure (e.g., no code detected in frame).
            const onScanFailure = (error) => {
                // We're just logging the error, not displaying it, as it's common during scanning.
                console.warn(`QR Code scan error: ${error}`);
            };

            // Main entry point to get cameras and start the scanner
            Html5Qrcode.getCameras().then(cameras => {
                // Instantiate the reader here, before any start calls
                html5QrCode = new Html5Qrcode("reader");

                if (cameras && cameras.length > 0) {
                    // Find front and rear cameras
                    const backCamera = cameras.find(camera => camera.label.toLowerCase().includes("back") || camera.label.toLowerCase().includes("rear") || camera.label.toLowerCase().includes("environment"));
                    const frontCamera = cameras.find(camera => camera.label.toLowerCase().includes("front") || camera.label.toLowerCase().includes("user"));
                    
                    if (cameras.length === 1) {
                        // Only one camera, start scanning immediately
                        currentCameraId = cameras[0].id;
                        startScanner(currentCameraId);
                    } else {
                        // Multiple cameras, set up buttons and start with the rear camera
                        cameraControls.classList.remove('hidden');
                        
                        frontCameraId = frontCamera ? frontCamera.id : null;
                        rearCameraId = backCamera ? backCamera.id : cameras[0].id; // Fallback to first camera if no rear is found
                        
                        // Set initial camera to rear if available, otherwise front
                        currentCameraId = rearCameraId || frontCameraId;

                        startScanner(currentCameraId);

                        // Add button event listeners
                        if (frontCameraId) {
                            frontCameraBtn.addEventListener('click', () => {
                                if (currentCameraId !== frontCameraId) {
                                    html5QrCode.stop().then(() => {
                                        currentCameraId = frontCameraId;
                                        startScanner(currentCameraId);
                                    }).catch(err => console.error(err));
                                }
                            });
                        } else {
                            frontCameraBtn.style.display = 'none';
                        }
                        
                        if (rearCameraId) {
                             rearCameraBtn.addEventListener('click', () => {
                                if (currentCameraId !== rearCameraId) {
                                    html5QrCode.stop().then(() => {
                                        currentCameraId = rearCameraId;
                                        startScanner(currentCameraId);
                                    }).catch(err => console.error(err));
                                }
                            });
                        } else {
                            rearCameraBtn.style.display = 'none';
                        }
                    }
                } else {
                    showMessage('No cameras found.', 'status-invalid');
                }
            }).catch(err => {
                console.error("Error getting cameras:", err);
                showMessage(`Error: ${err.name}. Unable to access cameras.`, 'status-invalid');
            });
        });
    </script>
</body>
</html>

